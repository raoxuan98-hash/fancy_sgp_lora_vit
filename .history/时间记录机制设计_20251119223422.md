# 分类器和分布补偿过程时间记录机制设计

## 1. 概述

本文档描述了在分类器构建和分布补偿过程中添加时间损耗记录的设计方案。

## 2. 现有代码分析

### 2.1 当前显存记录机制
- 在 `classifier_builder.py` 中已有 `log_memory_usage()` 函数
- 在 `distribution_compensator.py` 中已有 `_log_memory_usage()` 方法
- 现有机制记录GPU显存使用情况

### 2.2 需要添加时间记录的位置

#### 分类器构建过程：
1. `ClassifierReconstructor.build_classifiers()` - 主要分类器构建入口
2. 各个分类器构建器的 `build()` 方法：
   - `LDAClassifierBuilder.build()`
   - `QDAClassifierBuilder.build()`
   - `SGDClassifierBuilder.build()`
   - `LeastSquaresClassifierBuilder.build()`

#### 分布补偿过程：
1. `DistributionCompensator.build_all_variants()` - 主入口方法
2. `extract_features_before_after()` - 特征提取过程
3. 各个补偿器计算方法：
   - `_compute_linear_transform()`
   - `_compute_weaknonlinear_transform()`
   - `_compute_attention_transform()`
4. `_update_variants_with_transforms()` - 变体更新过程

## 3. 时间记录机制设计

### 3.1 统一时间记录函数

```python
def log_time_usage(operation_name: str, start_time: float, end_time: float):
    """记录时间损耗情况"""
    elapsed_time = end_time - start_time
    logging.info(f"[Time] {operation_name}: {elapsed_time:.4f}s")
```

### 3.2 时间记录装饰器

为了简化代码，可以设计一个装饰器：

```python
import time
import functools

def time_logger(operation_name=None):
    """时间记录装饰器"""
    def decorator(func):
        @functools.wraps(func)
        def wrapper(*args, **kwargs):
            op_name = operation_name or f"{func.__name__}"
            start_time = time.time()
            result = func(*args, **kwargs)
            end_time = time.time()
            log_time_usage(op_name, start_time, end_time)
            return result
        return wrapper
    return decorator
```

### 3.3 日志格式规范

#### 时间记录日志格式：
- 分类器构建：`[Time] Classifier LDA + SeqFT built: 0.1234s`
- 补偿器计算：`[Time] LinearCompensator computation: 0.5678s`
- 特征提取：`[Time] extract_features_before_after: 2.3456s`
- 整体构建：`[Time] build_all_variants for task 3: 5.6789s`

#### 与现有显存记录结合：
- 同时记录时间和显存：`[Time & GPU] Classifier LDA + SeqFT: 0.1234s, Allocated=1.23GB (+0.12GB)`

## 4. 具体实现方案

### 4.1 在 classifier_builder.py 中

1. 添加 `time` 模块导入
2. 添加 `log_time_usage()` 函数
3. 在 `build_classifiers()` 方法中添加时间记录
4. 对每个分类器构建过程进行计时

### 4.2 在 distribution_compensator.py 中

1. 添加 `time` 模块导入
2. 在各个方法中添加时间记录点
3. 统一日志格式与显存记录保持一致

### 4.3 在分类器构建器中

1. 在各个 `build()` 方法中添加时间记录
2. 确保时间记录与上层调用保持一致

## 5. 性能考虑

1. 时间记录的开销应该尽可能小
2. 使用 `time.time()` 获得高精度时间戳
3. 对于频繁调用的小函数，可以选择性记录

## 6. 测试验证

1. 验证时间记录的准确性
2. 确认日志格式的正确性
3. 检查性能开销是否可接受
4. 验证与现有显存记录的兼容性

## 7. 示例输出

```
[INFO] [Time] Classifier LDA + SeqFT built: 0.1234s
[INFO] [Time & GPU] Classifier QDA + SeqFT built: 0.2345s, Allocated=1.45GB (+0.15GB)
[INFO] [Time] LinearCompensator computation: 0.5678s
[INFO] [Time] build_all_variants for task 3: 5.6789s
[INFO] [Time & GPU] Compensation for SeqFT + linear: 1.2345s, Allocated=2.10GB (+0.30GB)
```

## 8. 后续扩展

1. 可以添加时间统计功能，计算累计时间
2. 可以添加时间分析报告
3. 可以与性能分析工具集成